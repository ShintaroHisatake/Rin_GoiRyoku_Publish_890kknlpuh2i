<!doctype html>
<html lang="ja">
<head>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>語句学習アプリ</title>

  <!-- ライブラリ読み込み -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <meta name="color-scheme" content="light only"/>
</head>
<body class="bg-slate-50">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel" data-presets="react">
    const {useEffect, useMemo, useRef, useState} = React;

    // ================== ユーティリティ ==================
    const Modes = { VIEW:"VIEW", MCQ:"MCQ" }; // モード1/2
    const Groups = { DAY:"DAY", WEEK:"WEEK" };

    const fetchJson = async (path) => {
      const res = await fetch(path, { cache:"no-store" });
      if (!res.ok) throw new Error(path + " を取得できません（" + res.status + "）");
      return await res.json();
    };

    const shuffle = (arr) => {
      const a = [...arr];
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    };

    // ================== ルート ==================
    function App(){
      const [data, setData] = useState(null);
      const [error, setError] = useState("");
      const [group, setGroup] = useState(Groups.DAY);     // DAY or WEEK
      const [dayId, setDayId] = useState("DAY1");         // DAY選択時のみ有効
      const [mode, setMode] = useState(Modes.VIEW);       // モード1/2
      const [loading, setLoading] = useState(false);

      useEffect(()=>{
        (async()=>{
          try{
            setLoading(true);
            const j = await fetchJson("./data/week1.json");
            setData(j);
          }catch(e){
            console.error(e);
            setError(e.message || String(e));
          }finally{
            setLoading(false);
          }
        })();
      },[]);

      if (error){
        return (
          <div className="max-w-3xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-3">読み込みエラー</h1>
            <p className="text-red-600 whitespace-pre-wrap">{error}</p>
            <p className="mt-3 text-sm text-slate-600">
              リポジトリ内に <code>data/week1.json</code> が存在するか確認してください。
            </p>
          </div>
        );
      }

      if (loading || !data){
        return <div className="p-6 text-slate-600">データ読み込み中…</div>;
      }

      // ★ optional chaining / null合体をやめた版
      const dayOptions = data.days ? data.days.map(function(d){
        return { value: d.id, label: d.label };
      }) : [];

      const activeItems = useMemo(function(){
        if (group === Groups.WEEK) {
          return data.week && data.week.items ? data.week.items : [];
        }
        const day = (data.days || []).find(function(d){ return d.id === dayId; });
        return day ? (day.items || []) : [];
      }, [data, group, dayId]);

      return (
        <div className="max-w-5xl mx-auto p-6 grid gap-6">
          <header className="flex flex-wrap items-center justify-between gap-3">
            <h1 className="text-2xl md:text-3xl font-bold">語句学習アプリ</h1>
            <div className="flex flex-wrap items-center gap-2">
              <select
                className="px-3 py-2 rounded-xl border bg-white"
                value={group}
                onChange={(e)=>setGroup(e.target.value)}
                title="Day/Week切替"
              >
                <option value={Groups.DAY}>Dayごと</option>
                <option value={Groups.WEEK}>週ごと（全体）</option>
              </select>

              {group===Groups.DAY && (
                <select
                  className="px-3 py-2 rounded-xl border bg-white"
                  value={dayId}
                  onChange={(e)=>setDayId(e.target.value)}
                  title="Day選択"
                >
                  {dayOptions.map(function(opt){
                    return (
                      <option key={opt.value} value={opt.value}>{opt.label}</option>
                    );
                  })}
                </select>
              )}

              <select
                className="px-3 py-2 rounded-xl border bg-white"
                value={mode}
                onChange={(e)=>setMode(e.target.value)}
                title="モード選択"
              >
                <option value={Modes.VIEW}>モード1：語句・意味・例文を表示</option>
                <option value={Modes.MCQ}>モード2：意味→語句（10択）</option>
              </select>
            </div>
          </header>

          <main className="rounded-2xl border bg-white p-6 shadow-sm">
            {mode===Modes.VIEW
              ? <ModeView items={activeItems}/>
              : <ModeMCQ items={activeItems}/>
            }
          </main>

          <footer className="text-center text-xs text-slate-500">
            <p>© {new Date().getFullYear()} 語句学習</p>
          </footer>
        </div>
      );
    }

    // ================== モード1：閲覧 ==================
    function ModeView({items}){
      const [i, setI] = useState(0);
      const total = items.length;
      const cur = items[i];

      if (!total) return <div className="text-slate-600">この範囲に項目がありません。</div>;

      return (
        <div className="grid gap-6">
          <div className="flex items-center gap-2 text-sm">
            <span className="px-2 py-1 rounded-full bg-slate-100">項目 {i+1} / {total}</span>
            <span className="ml-auto px-2 py-1 rounded-full bg-slate-900 text-white">全{total}件</span>
          </div>

          <div className="grid gap-4">
            <div>
              <div className="text-xs text-slate-500">語句</div>
              <div className="text-3xl md:text-4xl font-extrabold">{cur.term}</div>
            </div>
            <div>
              <div className="text-xs text-slate-500">意味</div>
              <div className="text-lg md:text-xl">{cur.meaning}</div>
            </div>
            {cur.example && (
              <div>
                <div className="text-xs text-slate-500">例文</div>
                <div className="text-base leading-relaxed">{cur.example}</div>
              </div>
            )}
          </div>

          <div className="flex items-center justify-between">
            <button
              className="px-4 py-2 rounded-xl border bg-white"
              onClick={()=>setI(function(v){ return v-1<0 ? total-1 : v-1; })}
            >
              ← 前へ
            </button>
            <button
              className="px-4 py-2 rounded-xl bg-slate-900 text-white"
              onClick={()=>setI(function(v){ return v+1>=total ? 0 : v+1; })}
            >
              次へ →
            </button>
          </div>
        </div>
      );
    }

    // ================== モード2：10択クイズ ==================
    function ModeMCQ({items}){
      const pool = useMemo(function(){ return items; }, [items]); // 出題範囲
      const total = pool.length;
      const [order, setOrder] = useState(()=> shuffle(pool.map(function(_,i){ return i; })));
      const [qIdx, setQIdx] = useState(0);
      const [selected, setSelected] = useState(null);
      const [correct, setCorrect] = useState(null);
      const [score, setScore] = useState(0);

      useEffect(()=>{
        setOrder(shuffle(items.map(function(_,i){ return i; })));
        setQIdx(0);
        setSelected(null);
        setCorrect(null);
        setScore(0);
      }, [items]);

      if (!total) return <div className="text-slate-600">この範囲に項目がありません。</div>;

      const current = pool[order[qIdx]];

      // 選択肢の作成（語句10個）
      const optionIndices = useMemo(function(){
        const others = pool.map(function(_,i){ return i; }).filter(function(i){ return i!==order[qIdx]; });
        const distractors = shuffle(others).slice(0, Math.max(0, 9)); // 残り9
        return shuffle([order[qIdx]].concat(distractors));
      }, [order, qIdx, pool]);

      const submit = (choiceIdx) => {
        if (correct!==null) return; // 回答済み
        setSelected(choiceIdx);
        const ok = choiceIdx === order[qIdx];
        setCorrect(ok);
        if (ok) setScore(function(s){ return s+1; });
      };

      const nextQ = () => {
        setSelected(null);
        setCorrect(null);
        setQIdx(function(v){ return v+1>=order.length ? 0 : v+1; });
      };

      return (
        <div className="grid gap-6">
          <div className="flex items-center gap-2 text-sm">
            <span className="px-2 py-1 rounded-full bg-slate-100">問題 {qIdx+1} / {total}</span>
            <span className="ml-auto px-2 py-1 rounded-full bg-slate-900 text-white">
              正答 {score} / {qIdx + (correct!==null?1:0)}
            </span>
          </div>

          <div>
            <div className="text-xs text-slate-500">意味</div>
            <div className="text-lg md:text-xl">{current.meaning}</div>
          </div>

          <ol className="grid md:grid-cols-2 gap-3">
            {optionIndices.map(function(idx, i){
              const term = pool[idx].term;
              const isChosen = selected!==null && idx===selected;
              const isAnswer = selected!==null && idx===order[qIdx];
              const baseClass = "w-full text-left px-4 py-3 rounded-xl border transition ";
              let cls = baseClass;
              if (isAnswer) {
                cls += "bg-emerald-50 border-emerald-300";
              } else if (isChosen) {
                cls += "bg-rose-50 border-rose-300";
              } else {
                cls += "bg-white hover:bg-slate-50 border-slate-300";
              }
              return (
                <li key={i}>
                  <button
                    className={cls}
                    onClick={()=>submit(idx)}
                    disabled={selected!==null}
                  >
                    <span className="mr-2 font-mono text-slate-500">
                      {String.fromCharCode(65+i)}.
                    </span>
                    <span className="font-semibold">{term}</span>
                  </button>
                </li>
              );
            })}
          </ol>

          {selected!==null && (
            <div className="rounded-xl border p-4 bg-slate-50">
              <div className={"font-bold " + (correct ? "text-emerald-700" : "text-rose-700")}>
                {correct ? "正解！" : "不正解"}
              </div>
              {current.example && (
                <div className="mt-2 text-sm text-slate-700">
                  <span className="font-medium">例文：</span>{current.example}
                </div>
              )}
              <div className="mt-3">
                <button className="px-4 py-2 rounded-xl bg-slate-900 text-white" onClick={nextQ}>
                  次の問題へ →
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>

  <noscript>このアプリを使うにはJavaScriptを有効にしてください。</noscript>
</body>
</html>
