<!doctype html>
<html lang="ja">
<head>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>語句学習アプリ</title>

  <!-- Tailwind / React / Babel -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <meta name="color-scheme" content="light only"/>
</head>
<body class="bg-slate-50">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useRef, useState } = React;

    // ================== 定数 ==================
    const Modes = { VIEW: "VIEW", MCQ: "MCQ", CLOZE: "CLOZE" };   // モード1/2/3
    const Groups = { DAY: "DAY", WEEK: "WEEK" };

    // 利用する JSON ファイル一覧（必要ならここに追加）
    const DATASETS = [
      { id: "week1",  label: "Week 1",  path: "./data/week1.json" },
      { id: "week2",  label: "Week 2",  path: "./data/week2.json" },
      { id: "week13", label: "Week 13", path: "./data/week13.json" },
      { id: "week14", label: "Week 14", path: "./data/week14.json" },
      { id: "week16", label: "Week 16", path: "./data/week16.json" }
    ];

    // ================== ユーティリティ ==================
    const fetchJson = async (path) => {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error(`${path} を取得できません（${res.status}）`);
      return await res.json();
    };

    const shuffle = (arr) => {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const t = a[i];
        a[i] = a[j];
        a[j] = t;
      }
      return a;
    };

    const uniqByTerm = (items) => {
      const map = {};
      for (let i = 0; i < items.length; i++) {
        const key = items[i].term || ("__idx__" + i);
        map[key] = items[i];
      }
      return Object.values(map);
    };

    // 例文から空欄文を作る（最初に出てきた term を「＿＿＿＿」に置換）
    const makeClozeSentence = (example, term) => {
      if (!example || !term) return example || "";
      const idx = example.indexOf(term);
      if (idx === -1) return example; // 見つからなければそのまま
      return example.slice(0, idx) + "＿＿＿＿" + example.slice(idx + term.length);
    };

    // ================== ルートコンポーネント ==================
    function App() {
      const [datasetId, setDatasetId] = useState(DATASETS[0].id);
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");
      const [group, setGroup] = useState(Groups.DAY); // DAY or WEEK
      const [dayId, setDayId] = useState("DAY1");     // DAY選択
      const [mode, setMode] = useState(Modes.VIEW);   // VIEW / MCQ / CLOZE

      // データ読み込み
      useEffect(() => {
        const ds = DATASETS.find(d => d.id === datasetId);
        if (!ds) return;
        setLoading(true);
        setError("");
        setData(null);
        (async () => {
          try {
            const j = await fetchJson(ds.path);
            setData(j);
            // 初期 dayId
            if (j && Array.isArray(j.days) && j.days.length > 0) {
              setDayId(j.days[0].id || "DAY1");
            } else {
              setDayId("DAY1");
            }
          } catch (e) {
            setError(e.message || String(e));
          } finally {
            setLoading(false);
          }
        })();
      }, [datasetId]);

      const dayOptions = useMemo(() => {
        if (!data || !Array.isArray(data.days)) return [];
        return data.days.map(d => ({
          value: d.id,
          label: d.label || d.id
        }));
      }, [data]);

      // 出題範囲（items）を決定（week.items は使わない）
      const activeItems = useMemo(() => {
        if (!data || !Array.isArray(data.days)) return [];

        if (group === Groups.WEEK) {
          // 週ごと：全DAYの items をまとめる（week.items は使わない）
          const all = [];
          for (let i = 0; i < data.days.length; i++) {
            const d = data.days[i];
            if (Array.isArray(d.items)) {
              for (let j = 0; j < d.items.length; j++) {
                all.push(d.items[j]);
              }
            }
          }
          return uniqByTerm(all);
        }

        // Dayごと：選択された DAY だけ
        const day = (data.days || []).find(d => d.id === dayId);
        if (!day || !Array.isArray(day.items)) return [];
        return day.items;
      }, [data, group, dayId]);

      if (error) {
        return (
          <div className="max-w-3xl mx-auto p-6">
            <h1 className="text-2xl font-bold mb-3">読み込みエラー</h1>
            <p className="text-red-600 whitespace-pre-wrap">{error}</p>
          </div>
        );
      }

      if (loading || !data) {
        return (
          <div className="min-h-screen flex items-center justify-center text-slate-700">
            データ読み込み中…
          </div>
        );
      }

      const metaTitle = data.meta && data.meta.title ? data.meta.title : "語句データ";

      return (
        <div className="max-w-5xl mx-auto p-6 grid gap-6">
          <header className="flex flex-wrap items-center justify-between gap-3">
            <div className="grid gap-1">
              <h1 className="text-2xl md:text-3xl font-bold">語句学習アプリ</h1>
              <p className="text-xs text-slate-500">
                データセット：{metaTitle}
              </p>
            </div>

            <div className="flex flex-wrap items-center gap-2">
              {/* データセット選択 */}
              <select
                className="px-3 py-2 rounded-xl border bg-white text-sm"
                value={datasetId}
                onChange={(e) => setDatasetId(e.target.value)}
                title="Week の選択"
              >
                {DATASETS.map(ds => (
                  <option key={ds.id} value={ds.id}>{ds.label}</option>
                ))}
              </select>

              {/* Day / Week 切り替え */}
              <select
                className="px-3 py-2 rounded-xl border bg-white text-sm"
                value={group}
                onChange={(e) => setGroup(e.target.value)}
                title="Day/Week切替"
              >
                <option value={Groups.DAY}>Dayごと</option>
                <option value={Groups.WEEK}>週ごと（全体）</option>
              </select>

              {/* Day 選択（Dayモードのときだけ） */}
              {group === Groups.DAY && (
                <select
                  className="px-3 py-2 rounded-xl border bg-white text-sm"
                  value={dayId}
                  onChange={(e) => setDayId(e.target.value)}
                  title="Day選択"
                >
                  {dayOptions.map(opt => (
                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                  ))}
                </select>
              )}

              {/* モード選択 */}
              <select
                className="px-3 py-2 rounded-xl border bg-white text-sm"
                value={mode}
                onChange={(e) => setMode(e.target.value)}
                title="モード選択"
              >
                <option value={Modes.VIEW}>モード1：語句・読み・意味・例文</option>
                <option value={Modes.MCQ}>モード2：意味→語句（10択）</option>
                <option value={Modes.CLOZE}>モード3：例文穴埋め</option>
              </select>
            </div>
          </header>

          <main className="rounded-2xl border bg-white p-6 shadow-sm min-h-[320px]">
            {mode === Modes.VIEW && (
              <ModeView items={activeItems} />
            )}
            {mode === Modes.MCQ && (
              <ModeMCQ items={activeItems} />
            )}
            {mode === Modes.CLOZE && (
              <ModeCloze items={activeItems} />
            )}
          </main>

          <footer className="text-center text-xs text-slate-500">
            <p>© {new Date().getFullYear()} 語句学習</p>
          </footer>
        </div>
      );
    }

    // ================== モード1：閲覧（語句＋読み＋意味＋例文） ==================
    function ModeView({ items }) {
      const safeItems = Array.isArray(items) ? items : [];
      const [idx, setIdx] = useState(0);
      const total = safeItems.length;

      useEffect(() => {
        // items が変わったらリセット
        setIdx(0);
      }, [items]);

      if (!total) {
        return <div className="text-slate-600">この範囲に項目がありません。</div>;
      }

      const cur = safeItems[idx];

      const goPrev = () => {
        setIdx(v => (v - 1 < 0 ? total - 1 : v - 1));
      };

      const goNext = () => {
        setIdx(v => (v + 1 >= total ? 0 : v + 1));
      };

      return (
        <div className="grid gap-6">
          <div className="flex items-center gap-2 text-sm">
            <span className="px-2 py-1 rounded-full bg-slate-100">
              項目 {idx + 1} / {total}
            </span>
          </div>

          <div className="grid gap-4">
            <div>
              <div className="text-xs text-slate-500">語句</div>
              <div className="text-3xl md:text-4xl font-extrabold">{cur.term}</div>
            </div>
            {cur.reading && (
              <div>
                <div className="text-xs text-slate-500">読み</div>
                <div className="text-xl md:text-2xl">{cur.reading}</div>
              </div>
            )}
            <div>
              <div className="text-xs text-slate-500">意味</div>
              <div className="text-lg md:text-xl">{cur.meaning}</div>
            </div>
            {cur.example && (
              <div>
                <div className="text-xs text-slate-500">例文</div>
                <div className="text-base leading-relaxed">{cur.example}</div>
              </div>
            )}
          </div>

          <div className="flex items-center justify-between">
            <button
              className="px-4 py-2 rounded-xl border bg-white hover:bg-slate-50"
              onClick={goPrev}
            >
              ← 前へ
            </button>
            <button
              className="px-4 py-2 rounded-xl bg-slate-900 text-white hover:opacity-90"
              onClick={goNext}
            >
              次へ →
            </button>
          </div>
        </div>
      );
    }

    // ================== モード2：10択クイズ ==================
    function ModeMCQ({ items }) {
      const safeItems = Array.isArray(items) ? items : [];
      const [order, setOrder] = useState([]);
      const [qIdx, setQIdx] = useState(0);
      const [selectedIdx, setSelectedIdx] = useState(null);
      const [isCorrect, setIsCorrect] = useState(null);
      const [score, setScore] = useState(0);
      const [answeredCount, setAnsweredCount] = useState(0);
      const nextButtonRef = useRef(null);

      useEffect(() => {
        if (!safeItems.length) {
          setOrder([]);
          setQIdx(0);
          setSelectedIdx(null);
          setIsCorrect(null);
          setScore(0);
          setAnsweredCount(0);
          return;
        }
        const idxs = safeItems.map((_, i) => i);
        setOrder(shuffle(idxs));
        setQIdx(0);
        setSelectedIdx(null);
        setIsCorrect(null);
        setScore(0);
        setAnsweredCount(0);
      }, [items]);

      const total = order.length;
      if (!total) {
        return <div className="text-slate-600">この範囲に項目がありません。</div>;
      }

      const currentIndex = order[qIdx];
      const current = safeItems[currentIndex];

      // 選択肢（10個まで）を作成（useMemo をやめてシンプルに）
      const allIdx = safeItems.map((_, i) => i);
      const others = allIdx.filter(i => i !== currentIndex);
      const distractors = shuffle(others).slice(0, Math.min(9, others.length)); // 残り最大9
      const optionIndices = shuffle([currentIndex].concat(distractors));

      const handleSelect = (idx) => {
        if (selectedIdx !== null) return; // 既に回答済み
        setSelectedIdx(idx);
        const ok = idx === currentIndex;
        setIsCorrect(ok);
        setAnsweredCount(c => c + 1);
        if (ok) setScore(s => s + 1);
      };

      const handleNext = () => {
        setSelectedIdx(null);
        setIsCorrect(null);
        setQIdx(v => (v + 1 >= order.length ? 0 : v + 1));
      };

      // 回答後に「次の問題へ」ボタンへフォーカス → Enter で遷移しやすくする
      useEffect(() => {
        if (selectedIdx !== null && nextButtonRef.current) {
          nextButtonRef.current.focus();
        }
      }, [selectedIdx]);

      const chosenItem = selectedIdx !== null ? safeItems[selectedIdx] : null;
      const correctItem = current;

      return (
        <div className="grid gap-6">
          <div className="flex items-center gap-2 text-sm">
            <span className="px-2 py-1 rounded-full bg-slate-100">
              問題 {qIdx + 1} / {total}
            </span>
            <span className="ml-auto px-2 py-1 rounded-full bg-slate-900 text-white">
              正答 {score} / {answeredCount}
            </span>
          </div>

          <div>
            <div className="text-xs text-slate-500">意味</div>
            <div className="text-lg md:text-xl">{current.meaning}</div>
          </div>

          <ol className="grid md:grid-cols-2 gap-3">
            {optionIndices.map((idx, i) => {
              const item = safeItems[idx];
              const term = item ? item.term : "";
              const isChosen = selectedIdx !== null && idx === selectedIdx;
              const isAnswer = selectedIdx !== null && idx === currentIndex;
              let className = "w-full text-left px-4 py-3 rounded-xl border transition ";
              if (selectedIdx === null) {
                className += "bg-white hover:bg-slate-50 border-slate-300";
              } else if (isAnswer) {
                className += "bg-emerald-50 border-emerald-300";
              } else if (isChosen) {
                className += "bg-rose-50 border-rose-300";
              } else {
                className += "bg-white border-slate-200 opacity-70";
              }

              return (
                <li key={i}>
                  <button
                    className={className}
                    onClick={() => handleSelect(idx)}
                    disabled={selectedIdx !== null}
                  >
                    <span className="mr-2 font-mono text-slate-500">
                      {String.fromCharCode(65 + i)}.
                    </span>
                    <span className="font-semibold">{term}</span>
                  </button>
                </li>
              );
            })}
          </ol>

          {selectedIdx !== null && (
            <div className="rounded-xl border p-4 bg-slate-50 text-sm">
              <div className={"font-bold " + (isCorrect ? "text-emerald-700" : "text-rose-700")}>
                {isCorrect ? "正解！" : "不正解"}
              </div>

              {/* 正解の情報 */}
              <div className="mt-2">
                <div className="text-xs text-slate-500">正解</div>
                <div className="font-semibold text-lg">
                  {correctItem.term}
                  {correctItem.reading && (
                    <span className="ml-2 text-sm text-slate-600">（{correctItem.reading}）</span>
                  )}
                </div>
                <div className="text-slate-700 mt-1">
                  意味：{correctItem.meaning}
                </div>
              </div>

              {/* 間違えた場合：自分が選んだ語句の意味も表示 */}
              {!isCorrect && chosenItem && (
                <div className="mt-3">
                  <div className="text-xs text-slate-500">あなたが選んだ語句</div>
                  <div className="font-semibold">
                    {chosenItem.term}
                    {chosenItem.reading && (
                      <span className="ml-2 text-sm text-slate-600">（{chosenItem.reading}）</span>
                    )}
                  </div>
                  <div className="text-slate-700 mt-1">
                    意味：{chosenItem.meaning}
                  </div>
                </div>
              )}

              {/* 例文（正解の） */}
              {correctItem.example && (
                <div className="mt-3 text-slate-700">
                  <span className="font-medium">例文：</span>
                  {correctItem.example}
                </div>
              )}

              <div className="mt-4">
                <button
                  ref={nextButtonRef}
                  className="px-4 py-2 rounded-xl bg-slate-900 text-white hover:opacity-90"
                  onClick={handleNext}
                >
                  次の問題へ →
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ================== モード3：例文穴埋め ==================
    function ModeCloze({ items }) {
      const safeItems = Array.isArray(items) ? items : [];
      const [order, setOrder] = useState([]);
      const [qIdx, setQIdx] = useState(0);
      const [input, setInput] = useState("");
      const [phase, setPhase] = useState("typing"); // "typing" or "result"
      const [isCorrect, setIsCorrect] = useState(null);
      const inputRef = useRef(null);

      useEffect(() => {
        if (!safeItems.length) {
          setOrder([]);
          setQIdx(0);
          setInput("");
          setPhase("typing");
          setIsCorrect(null);
          return;
        }
        const idxs = safeItems.map((_, i) => i);
        setOrder(shuffle(idxs)); // ランダム順
        setQIdx(0);
        setInput("");
        setPhase("typing");
        setIsCorrect(null);
      }, [items]);

      useEffect(() => {
        if (inputRef.current) {
          inputRef.current.focus();
        }
      }, [qIdx, phase]);

      const total = order.length;
      if (!total) {
        return <div className="text-slate-600">この範囲に項目がありません。</div>;
      }

      const currentIndex = order[qIdx];
      const current = safeItems[currentIndex];

      const clozeSentence = makeClozeSentence(current.example || "", current.term);

      const checkAnswer = () => {
        const user = (input || "").replace(/\s/g, "");
        const ans = (current.term || "").replace(/\s/g, "");
        const ok = user.length > 0 && user === ans;
        setIsCorrect(ok);
        setPhase("result");
      };

      const nextQuestion = () => {
        setInput("");
        setPhase("typing");
        setIsCorrect(null);
        setQIdx(v => (v + 1 >= order.length ? 0 : v + 1));
      };

      const handleKeyDown = (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          if (phase === "typing") {
            checkAnswer(); // 1回目の Enter → 判定
          } else {
            nextQuestion(); // 2回目の Enter → 次の問題へ
          }
        }
      };

      return (
        <div className="grid gap-6">
          <div className="flex items-center gap-2 text-sm">
            <span className="px-2 py-1 rounded-full bg-slate-100">
              問題 {qIdx + 1} / {total}
            </span>
            <span className="ml-auto text-xs text-slate-500">
              Enter 1回目：判定 ／ Enter 2回目：次の問題へ
            </span>
          </div>

          <div className="grid gap-3">
            <div>
              <div className="text-xs text-slate-500">例文（空欄部分に語句が入る）</div>
              <div className="text-base md:text-lg leading-relaxed">
                {clozeSentence}
              </div>
            </div>
            <div>
              <div className="text-xs text-slate-500">語句の意味</div>
              <div className="text-sm md:text-base text-slate-800">
                {current.meaning}
              </div>
            </div>
          </div>

          <div className="grid gap-2">
            <label className="grid gap-2">
              <span className="text-sm text-slate-600">空欄に入る語句（漢字で入力）</span>
              <input
                ref={inputRef}
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                className="px-4 py-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-4 focus:ring-slate-100"
                placeholder="語句を入力（例：気休め）"
                autoCapitalize="none"
                autoComplete="off"
                autoCorrect="off"
                spellCheck={false}
              />
            </label>

            <div className="flex items-center gap-3 mt-2">
              <button
                className="px-4 py-2 rounded-xl bg-slate-900 text-white hover:opacity-90"
                onClick={phase === "typing" ? checkAnswer : nextQuestion}
              >
                {phase === "typing" ? "判定（Enter 一回目）" : "次の問題へ（Enter 二回目）"}
              </button>
            </div>
          </div>

          {phase === "result" && (
            <div className="mt-4 rounded-xl border p-4 bg-slate-50 text-sm">
              <div className={"font-bold " + (isCorrect ? "text-emerald-700" : "text-rose-700")}>
                {isCorrect ? "正解！" : "不正解"}
              </div>
              <div className="mt-2">
                <div className="text-xs text-slate-500">正解の語句</div>
                <div className="font-semibold text-lg">
                  {current.term}
                  {current.reading && (
                    <span className="ml-2 text-sm text-slate-600">（{current.reading}）</span>
                  )}
                </div>
                <div className="mt-1 text-slate-700">
                  意味：{current.meaning}
                </div>
              </div>
              {current.example && (
                <div className="mt-3 text-slate-700">
                  <span className="font-medium">例文（元の文）：</span>
                  {current.example}
                </div>
              )}
              <div className="mt-3 text-xs text-slate-500">
                Enter をもう一度押すと、次の問題に進みます。
              </div>
            </div>
          )}
        </div>
      );
    }

    // ================== React 起動 ==================
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>

  <noscript>このアプリを使うにはJavaScriptを有効にしてください。</noscript>
</body>
</html>
